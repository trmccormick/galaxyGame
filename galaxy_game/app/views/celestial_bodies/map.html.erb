<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= @celestial_body.name %> - Planet Map Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: #eee;
        }
        
        #mapContainer {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        #canvasWrapper {
            flex: 1;
            position: relative;
        }
        
        canvas {
            border: 2px solid #0f3460;
            cursor: crosshair;
            background: #000;
        }
        
        #controls {
            width: 300px;
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
        }
        
        h2 {
            color: #e94560;
            margin-top: 0;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
        }
        
        input[type="range"] {
            width: 100%;
        }
        
        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            background: #ff6b6b;
        }
        
        #featureInfo {
            background: #0f3460;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .layer-toggle {
            margin: 5px 0;
        }
        
        .layer-toggle input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .value-display {
            color: #e94560;
            font-weight: bold;
        }
        
        .back-link {
            color: #0ff;
            text-decoration: none;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .feature-marker {
            cursor: pointer;
        }
        
        .priority-high {
            fill: #0f0;
        }
        
        .priority-medium {
            fill: #ff0;
        }
        
        .priority-critical {
            fill: #f0f;
        }
    </style>
</head>
<body>
    <a href="<%= celestial_bodies_path %>" class="back-link">← Back to Celestial Bodies</a>
    
    <div id="mapContainer">
        <div id="canvasWrapper">
            <canvas id="planetCanvas" width="800" height="400"></canvas>
        </div>
        
        <div id="controls">
            <h2><%= @celestial_body.name %> Map</h2>
            
            <div class="control-group">
                <label>Zoom: <span id="zoomValue" class="value-display">1.0x</span></label>
                <input type="range" id="zoom" min="0.5" max="4" step="0.1" value="1">
            </div>
            
            <div class="control-group">
                <h3>Visible Layers:</h3>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerLavaTubes" checked>
                    <label for="layerLavaTubes">Lava Tubes</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerCraters" checked>
                    <label for="layerCraters">Craters</label>
                </div>
                <div class="layer-toggle">
                    <input type="checkbox" id="layerSettlements">
                    <label for="layerSettlements">Settlements</label>
                </div>
            </div>
            
            <div id="featureInfo">
                <h3>Feature Information</h3>
                <div id="featureDetails">Click on a feature to see details</div>
            </div>
        </div>
    </div>

    <script>
        // Main map class
        class PlanetMap {
            constructor(canvasId, celestialBodyId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.celestialBodyId = celestialBodyId;
                this.mapData = null;
                this.zoom = 1.0;
                this.offsetX = 0;
                this.offsetY = 0;
                this.layers = {
                    lavaTubes: true,
                    craters: true,
                    settlements: false
                };
                
                this.setupEventListeners();
                this.loadMapData();
            }

            setupEventListeners() {
                this.canvas.addEventListener('click', (e) => this.handleClick(e));
                
                document.getElementById('zoom').addEventListener('input', (e) => {
                    this.zoom = parseFloat(e.target.value);
                    document.getElementById('zoomValue').textContent = this.zoom.toFixed(1) + 'x';
                    this.render();
                });
                
                ['layerLavaTubes', 'layerCraters', 'layerSettlements'].forEach(id => {
                    document.getElementById(id).addEventListener('change', (e) => {
                        const layer = id.replace('layer', '').charAt(0).toLowerCase() + id.replace('layer', '').slice(1);
                        this.layers[layer] = e.target.checked;
                        this.render();
                    });
                });
            }

            async loadMapData() {
                try {
                    const response = await fetch(`/celestial_bodies/${this.celestialBodyId}/geological_features`);
                    if (!response.ok) {
                        throw new Error('Failed to load geological features');
                    }
                    this.mapData = await response.json();
                    this.render();
                } catch (error) {
                    console.error('Error loading map data:', error);
                    document.getElementById('featureDetails').innerHTML = 
                        '<span style="color: #e94560">Error loading map data</span>';
                }
            }

            latLonToPixel(lat, lon) {
                // Equirectangular projection
                const x = ((lon + 180) / 360) * this.canvas.width;
                const y = ((90 - lat) / 180) * this.canvas.height;
                return { x, y };
            }

            pixelToLatLon(x, y) {
                const lat = 90 - (y / this.canvas.height) * 180;
                const lon = (x / this.canvas.width) * 360 - 180;
                return { lat, lon };
            }

            render() {
                if (!this.mapData) return;
                
                // Clear canvas
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw grid lines for reference
                this.drawGrid();
                
                // Draw features
                if (this.layers.lavaTubes && this.mapData.lava_tubes) {
                    this.drawFeatures(this.mapData.lava_tubes, '#00ffff');
                }
                
                if (this.layers.craters && this.mapData.craters) {
                    this.drawFeatures(this.mapData.craters, '#ffff00');
                }
            }

            drawGrid() {
                this.ctx.strokeStyle = '#1a1a3e';
                this.ctx.lineWidth = 1;
                
                // Latitude lines (every 30 degrees)
                for (let lat = -90; lat <= 90; lat += 30) {
                    const start = this.latLonToPixel(lat, -180);
                    const end = this.latLonToPixel(lat, 180);
                    this.ctx.beginPath();
                    this.ctx.moveTo(start.x, start.y);
                    this.ctx.lineTo(end.x, end.y);
                    this.ctx.stroke();
                }
                
                // Longitude lines (every 30 degrees)
                for (let lon = -180; lon <= 180; lon += 30) {
                    const start = this.latLonToPixel(-90, lon);
                    const end = this.latLonToPixel(90, lon);
                    this.ctx.beginPath();
                    this.ctx.moveTo(start.x, start.y);
                    this.ctx.lineTo(end.x, end.y);
                    this.ctx.stroke();
                }
            }

            drawFeatures(features, defaultColor) {
                features.forEach(feature => {
                    if (!feature.lat || !feature.lon) return;
                    
                    const pos = this.latLonToPixel(feature.lat, feature.lon);
                    
                    // Determine color based on priority
                    let color = defaultColor;
                    if (feature.priority === 'critical') color = '#ff00ff';
                    else if (feature.priority === 'high') color = '#00ff00';
                    else if (feature.priority === 'medium') color = '#ffff00';
                    
                    // Draw marker
                    this.ctx.fillStyle = color;
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, 5 * this.zoom, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // Draw border
                    this.ctx.strokeStyle = '#fff';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                    
                    // Draw label for high-priority features
                    if (feature.priority === 'critical' || feature.priority === 'high') {
                        this.ctx.fillStyle = '#fff';
                        this.ctx.font = '10px Arial';
                        this.ctx.fillText(feature.name, pos.x + 8, pos.y + 4);
                    }
                });
            }

            handleClick(event) {
                if (!this.mapData) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                // Check all features for clicks
                const clickedFeature = this.findFeatureAtPoint(x, y);
                
                if (clickedFeature) {
                    this.showFeatureInfo(clickedFeature);
                } else {
                    const coords = this.pixelToLatLon(x, y);
                    document.getElementById('featureDetails').innerHTML = 
                        `<strong>Coordinates:</strong><br>` +
                        `Lat: ${coords.lat.toFixed(2)}°<br>` +
                        `Lon: ${coords.lon.toFixed(2)}°`;
                }
            }

            findFeatureAtPoint(x, y) {
                const threshold = 10 * this.zoom; // Click detection radius
                
                const allFeatures = [
                    ...(this.layers.lavaTubes ? this.mapData.lava_tubes : []),
                    ...(this.layers.craters ? this.mapData.craters : [])
                ];
                
                for (const feature of allFeatures) {
                    if (!feature.lat || !feature.lon) continue;
                    
                    const pos = this.latLonToPixel(feature.lat, feature.lon);
                    const distance = Math.sqrt((pos.x - x) ** 2 + (pos.y - y) ** 2);
                    
                    if (distance <= threshold) {
                        return feature;
                    }
                }
                
                return null;
            }

            showFeatureInfo(feature) {
                let html = `
                    <strong>${feature.name}</strong><br>
                    <strong>Type:</strong> ${feature.type}<br>
                    <strong>Coordinates:</strong> ${feature.lat.toFixed(2)}°, ${feature.lon.toFixed(2)}°<br>
                    <strong>Priority:</strong> <span style="color: ${this.getPriorityColor(feature.priority)}">${feature.priority || 'N/A'}</span><br>
                `;
                
                if (feature.dimensions) {
                    html += `<br><strong>Dimensions:</strong><br>`;
                    if (feature.dimensions.diameter_m) {
                        html += `Diameter: ${feature.dimensions.diameter_m.toLocaleString()} m<br>`;
                    }
                    if (feature.dimensions.depth_m) {
                        html += `Depth: ${feature.dimensions.depth_m.toLocaleString()} m<br>`;
                    }
                    if (feature.dimensions.estimated_volume_m3) {
                        html += `Volume: ${(feature.dimensions.estimated_volume_m3 / 1000000).toFixed(2)} million m³<br>`;
                    }
                }
                
                if (feature.resources) {
                    html += `<br><strong>Resources:</strong><br>`;
                    Object.entries(feature.resources).forEach(([key, value]) => {
                        html += `${key}: ${value.toLocaleString()}<br>`;
                    });
                }
                
                if (feature.strategic_value && feature.strategic_value.length > 0) {
                    html += `<br><strong>Strategic Value:</strong><br>`;
                    feature.strategic_value.forEach(value => {
                        html += `• ${value}<br>`;
                    });
                }
                
                document.getElementById('featureDetails').innerHTML = html;
            }

            getPriorityColor(priority) {
                switch(priority) {
                    case 'critical': return '#ff00ff';
                    case 'high': return '#00ff00';
                    case 'medium': return '#ffff00';
                    default: return '#aaa';
                }
            }
        }

        // Initialize map on page load
        window.addEventListener('load', () => {
            const celestialBodyId = <%= @celestial_body.id %>;
            new PlanetMap('planetCanvas', celestialBodyId);
        });
    </script>
</body>
</html>
