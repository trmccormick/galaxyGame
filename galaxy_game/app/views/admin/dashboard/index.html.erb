<!-- app/views/admin/dashboard/index.html.erb -->

<%= stylesheet_link_tag 'admin/dashboard', media: 'all' %>
<%= stylesheet_link_tag 'application', media: 'all' %>

<div class="admin-main-container dashboard-2col">
  <style>
    /* Dashboard-specific override: force 2-column layout */
    .dashboard-2col {
      display: grid;
      grid-template-columns: 250px 1fr !important;
      grid-template-rows: 80px 1fr 200px;
      height: 100vh;
      gap: 2px;
      background: #111;
    }
  </style>
  <!-- Header -->
  <header class="admin-header">
    <h1>GALAXY GAME - ADMIN CONTROL CENTER</h1>
    <div class="admin-header-info">
      System Status: <span class="text-success">OPERATIONAL</span> |
      Uptime: <%= @system_stats[:uptime] %> |
      Version: 1.0.0-alpha |
      Systems: <%= @galaxy_stats[:total_systems] %>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <!-- Admin Sections Navigation -->
    <section class="admin-tool-section">
      <h3>üéØ ADMIN SECTIONS</h3>
      <%= link_to 'ü§ñ AI Manager', admin_ai_manager_path, class: 'admin-tool-button' %>
      <%= link_to 'üåå Solar Systems', admin_solar_systems_path, class: 'admin-tool-button' %>
      <%= link_to 'üåç Celestial Bodies', admin_celestial_bodies_path, class: 'admin-tool-button' %>
      <%= link_to 'üó∫Ô∏è Map Studio', admin_map_studio_path, class: 'admin-tool-button' %>
      <%= link_to 'üè¢ Organizations', admin_organizations_path, class: 'admin-tool-button' %>
      <%= link_to 'üèóÔ∏è Settlements', admin_settlements_path, class: 'admin-tool-button' %>
      <%= link_to 'üí∞ Resources & Market', admin_resources_path, class: 'admin-tool-button' %>
      <%= link_to '‚öôÔ∏è Simulation', admin_simulation_path, class: 'admin-tool-button' %>
    </section>

    <!-- Quick Actions -->
    <section class="admin-tool-section">
      <h3>üéÆ QUICK ACTIONS</h3>
      <%= link_to 'üè† Main Game', root_path, class: 'admin-tool-button' %>
      <%= link_to 'üìä Background Jobs', '/sidekiq', class: 'admin-tool-button', target: '_blank' %>
      <button class="admin-tool-button" onclick="refreshDashboard()">üîÑ Refresh Dashboard</button>
    </section>

    <!-- Quick Stats (Small, in sidebar) -->
    <section class="admin-tool-section">
      <h3>üåå QUICK STATS</h3>
      <div class="admin-stats">
        <div>
          <span>Systems:</span>
          <span class="admin-stat-value"><%= @galaxy_stats[:total_systems] %></span>
        </div>
        <div>
          <span>Bodies:</span>
          <span class="admin-stat-value"><%= @galaxy_stats[:total_bodies] %></span>
        </div>
        <div>
          <span>Settlements:</span>
          <span class="admin-stat-value"><%= @galaxy_stats[:settlements] %></span>
        </div>
        <div>
          <span>AI Status:</span>
          <span class="admin-stat-value <%= @ai_status[:manager_status] == 'online' ? 'text-success' : 'text-danger' %>">
            <%= @ai_status[:manager_status].upcase %>
          </span>
        </div>
      </div>
    </section>
  </aside>

  <!-- Main Content -->
  <main class="admin-content">
    <!-- Galaxy Overview Stats (Prominent at top) -->
    <section class="content-section">
      <h2>üìä GALAXY OVERVIEW</h2>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label">Total Systems</div>
          <div class="metric-value"><%= @galaxy_stats[:total_systems] %></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Total Bodies</div>
          <div class="metric-value"><%= @galaxy_stats[:total_bodies] %></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Habitable Bodies</div>
          <div class="metric-value"><%= @galaxy_stats[:habitable_bodies] %></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Active Settlements</div>
          <div class="metric-value"><%= @galaxy_stats[:settlements] %></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Total GCC</div>
          <div class="metric-value"><%= number_with_precision(@economic_indicators[:total_gcc] / 1_000_000.0, precision: 1) %>M</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Open Market Orders</div>
          <div class="metric-value"><%= @economic_indicators[:active_trades] %></div>
        </div>
      </div>
    </section>

    <!-- AI Manager Status -->
    <section class="content-section">
      <h2>ü§ñ AI MANAGER STATUS</h2>
      <div class="admin-section">
        <div class="data-row">
          <span class="data-label">Manager Status:</span>
          <span class="data-value <%= @ai_status[:manager_status] == 'online' ? 'text-success' : 'text-danger' %>">
            <%= @ai_status[:manager_status].upcase %>
          </span>
        </div>
        <div class="data-row">
          <span class="data-label">Bootstrap Capable:</span>
          <span class="data-value <%= @ai_status[:bootstrap_capable] ? 'text-success' : 'text-danger' %>">
            <%= @ai_status[:bootstrap_capable] ? 'YES' : 'NO' %>
          </span>
        </div>
        <div class="data-row">
          <span class="data-label">Learned Patterns:</span>
          <span class="data-value"><%= @ai_status[:learned_patterns] %></span>
        </div>
        <div class="data-row">
          <span class="data-label">Last Decision:</span>
          <span class="data-value"><%= time_ago_in_words(@ai_status[:last_decision]) %> ago</span>
        </div>
        <div class="data-row">
          <span class="data-label">Active Simulations:</span>
          <span class="data-value"><%= @ai_status[:active_simulations] || 0 %></span>
        </div>
      </div>
    </section>

    <!-- Economic Overview -->
    <section class="content-section">
      <h2>üí∞ ECONOMIC OVERVIEW</h2>
      <div class="admin-section">
        <div class="data-row">
          <span class="data-label">Total GCC in Circulation:</span>
          <span class="data-value"><%= number_with_precision(@economic_indicators[:total_gcc], precision: 0, delimiter: ',') %> GCC</span>
        </div>
        <div class="data-row">
          <span class="data-label">Minting Rate:</span>
          <span class="data-value"><%= number_with_delimiter(@economic_indicators[:minting_rate] || 1200) %> GCC/day</span>
        </div>
        <div class="data-row">
          <span class="data-label">Open Market Orders:</span>
          <span class="data-value"><%= @economic_indicators[:active_trades] %></span>
        </div>
        <div class="data-row">
          <span class="data-label">Today's Trade Volume:</span>
          <span class="data-value"><%= number_with_delimiter(@economic_indicators[:daily_volume] || 0) %> GCC</span>
        </div>
      </div>
    </section>

    <!-- Network Status (Optional - if wormholes matter for admin) -->
    <% if defined?(@network_stats) && @network_stats.present? %>
      <section class="content-section">
        <h2>üåê WORMHOLE NETWORK</h2>
        <div class="admin-section">
          <div class="data-row">
            <span class="data-label">Active Wormholes:</span>
            <span class="data-value"><%= @network_stats[:wormholes] %></span>
          </div>
          <div class="data-row">
            <span class="data-label">Connected Systems:</span>
            <span class="data-value"><%= @network_stats[:connected_systems] %></span>
          </div>
          <div class="data-row">
            <span class="data-label">Isolated Systems:</span>
            <span class="data-value <%= @network_stats[:isolated_systems] > 0 ? 'text-warning' : 'text-success' %>">
              <%= @network_stats[:isolated_systems] %>
            </span>
          </div>
        </div>
      </section>
    <% end %>

    <!-- Recent Activity Feed -->
    <section class="content-section">
      <h2>üìú RECENT ACTIVITY</h2>
      <div class="activity-list">
        <% if @recent_activity.any? %>
          <% @recent_activity.each do |activity| %>
            <div class="activity-item">
              <span class="activity-type">[<%= activity[:type].upcase %>]</span>
              <span class="activity-message"><%= activity[:message] %></span>
              <span class="activity-time"><%= time_ago_in_words(activity[:timestamp]) %> ago</span>
            </div>
          <% end %>
        <% else %>
          <div class="activity-item">
            <span class="activity-message">No recent activity</span>
          </div>
        <% end %>
      </div>
    </section>

    <!-- AI Activity Feed -->
    <section class="content-section">
      <h2>üß† AI ACTIVITY FEED</h2>
      <div class="activity-list">
        <% if @ai_activity_feed.any? %>
          <% @ai_activity_feed.each do |activity| %>
            <div class="activity-item">
              <span class="activity-type">[AI]</span>
              <span class="activity-message"><%= activity[:message] %></span>
              <% if activity[:details] %>
                <div class="activity-details"><%= activity[:details] %></div>
              <% end %>
              <span class="activity-time"><%= time_ago_in_words(activity[:timestamp]) %> ago</span>
            </div>
          <% end %>
        <% else %>
          <div class="activity-item">
            <span class="activity-message">No AI activity recorded</span>
          </div>
        <% end %>
      </div>

      <!-- AI Testing Controls -->
      <div class="admin-section" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #333;">
        <h3 style="margin: 0 0 10px 0; color: #00bfff;">AI BOOTSTRAP TESTING</h3>
        <button class="admin-tool-button" onclick="runGccBootstrapTest()" style="width: 100%; margin-bottom: 5px;">
          üöÄ Test GCC Bootstrap
        </button>
        <button class="admin-tool-button" onclick="runAiAnalysis()" style="width: 100%; margin-bottom: 5px;">
          üîç Run AI System Analysis
        </button>
        <button class="admin-tool-button" onclick="clearAiActivity()" style="width: 100%;">
          üóëÔ∏è Clear Activity Feed
        </button>
      </div>
    </section>
  </main>
</div>

<script>
  function refreshDashboard() {
    window.location.reload();
  }

  function runGccBootstrapTest() {
    if (confirm('Run GCC Bootstrap Test?\n\nThis will test the AI Manager\'s ability to autonomously deploy a mining satellite to bootstrap cryptocurrency generation.')) {
      <% earth_id = @celestial_bodies&.find { |b| b.name == 'Earth' }&.id || @celestial_bodies&.first&.id %>
      <% if earth_id %>
        window.location.href = '/admin/celestial_bodies/<%= earth_id %>/monitor';
      <% else %>
        alert('No celestial bodies available for testing. Please initialize the simulation first.');
      <% end %>
    }
  }

  function runAiAnalysis() {
    alert('AI System Analysis\n\nThis feature will analyze the current state of the AI Manager and provide recommendations for bootstrap actions.\n\nFeature coming soon!');
  }

  function clearAiActivity() {
    if (confirm('Clear AI Activity Feed?\n\nThis will remove all AI activity entries from the dashboard.')) {
      // TODO: Implement actual clearing functionality via backend
      alert('AI Activity Feed cleared (simulation).');
      location.reload();
    }
  }

  // Auto-refresh stats every 30 seconds
  setInterval(() => {
    fetch('/admin/dashboard')
      .then(response => response.text())
      .then(html => {
        console.log('Dashboard stats refreshed');
      })
      .catch(error => console.error('Refresh failed:', error));
  }, 30000);
</script>