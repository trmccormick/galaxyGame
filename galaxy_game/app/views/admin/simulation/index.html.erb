<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="<%= form_authenticity_token %>">
    <title>Simulation Control - Galaxy Game</title>
    <%= stylesheet_link_tag 'admin/monitor', media: 'all' %>
</head>
<body>
    <div id="mainContainer" style="grid-template-columns: 250px 1fr 300px; grid-template-rows: 80px 1fr;">
        <!-- Header -->
        <div id="header" style="grid-column: 1 / -1;">
            <h1>SIMULATION CONTROL CENTER</h1>
            <div id="planetInfo">
                System: <%= @solar_system&.name || 'No System Loaded' %> | 
                Bodies: <%= @celestial_bodies.count %> | 
                <%= link_to 'üè† Admin Dashboard', '/admin', style: 'color: #0ff; text-decoration: none;' %>
            </div>
        </div>
        
        <!-- Left Panel: Controls -->
        <div id="toolPanel">
            <div class="tool-section">
                <h3>‚öôÔ∏è SIMULATION CONTROLS</h3>
                <%= button_to '‚ñ∂Ô∏è Run All Bodies', admin_simulation_run_all_path, method: :post, class: 'tool-button', style: 'background: #0f0; color: #000; font-weight: bold;' %>
                <button class="tool-button" onclick="resetAllSpheres()">
                    üîÑ Reset All Spheres
                </button>
                <button class="tool-button" onclick="window.location.href='/'">
                    üéÆ Main Game
                </button>
            </div>
            
            <div class="tool-section">
                <h3>üïê TIME CONTROLS</h3>
                <button class="tool-button" onclick="advanceTime(1)">
                    ‚è≠Ô∏è Advance 1 Tick
                </button>
                <button class="tool-button" onclick="advanceTime(10)">
                    ‚è≠Ô∏è‚è≠Ô∏è Advance 10 Ticks
                </button>
                <button class="tool-button" onclick="advanceTime(100)">
                    ‚è© Advance 100 Ticks
                </button>
            </div>
            
            <div class="tool-section">
                <h3>üî¨ TESTING TOOLS</h3>
                <button class="tool-button" onclick="window.location.href='/admin'">
                    üìä View Metrics
                </button>
                <button class="tool-button" onclick="exportSimulationData()">
                    üíæ Export Data
                </button>
            </div>

            <div class="tool-section">
                <h3>ü§ñ AI MANAGER PRIORITY CONTROLS</h3>
                <div style="margin: 10px 0; font-size: 11px; color: #ccc;">
                    Adjust AI behavior priorities for testing scenarios
                </div>

                <!-- Critical Priorities -->
                <div style="margin: 10px 0;">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #ff6b6b;">
                        üî• Critical Priority Multiplier: <span id="critical-value"><%= number_with_precision(@ai_priority_system.critical_multiplier, precision: 1) %></span>x
                    </label>
                    <input type="range" id="critical-slider" min="0.1" max="5.0" step="0.1"
                           value="<%= @ai_priority_system.critical_multiplier %>"
                           style="width: 100%; margin: 5px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;">
                        <span>0.1x</span>
                        <span>1.0x (Default)</span>
                        <span>5.0x</span>
                    </div>
                </div>

                <!-- Operational Priorities -->
                <div style="margin: 10px 0;">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #4ecdc4;">
                        ‚öôÔ∏è Operational Priority Multiplier: <span id="operational-value"><%= number_with_precision(@ai_priority_system.operational_multiplier, precision: 1) %></span>x
                    </label>
                    <input type="range" id="operational-slider" min="0.1" max="5.0" step="0.1"
                           value="<%= @ai_priority_system.operational_multiplier %>"
                           style="width: 100%; margin: 5px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;">
                        <span>0.1x</span>
                        <span>1.0x (Default)</span>
                        <span>5.0x</span>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div style="margin: 15px 0; display: flex; gap: 5px;">
                    <button class="tool-button" id="update-priorities-btn" style="background: #4CAF50; flex: 1;">
                        ‚úÖ Apply Changes
                    </button>
                    <button class="tool-button" id="reset-priorities-btn" style="background: #ff9800; flex: 1;">
                        üîÑ Reset to Default
                    </button>
                </div>

                <!-- Priority Preview -->
                <div id="priority-preview" style="margin: 10px 0; padding: 8px; background: #1a1a1a; border-radius: 4px; font-size: 10px; display: none;">
                    <div style="color: #ff6b6b; margin-bottom: 5px;">
                        <strong>Critical Priorities:</strong><br>
                        Life Support: <span id="preview-critical-life-support">-</span><br>
                        Atmospheric: <span id="preview-critical-atmospheric">-</span><br>
                        Debt: <span id="preview-critical-debt">-</span>
                    </div>
                    <div style="color: #4ecdc4;">
                        <strong>Operational Priorities:</strong><br>
                        Resources: <span id="preview-operational-resources">-</span><br>
                        Construction: <span id="preview-operational-construction">-</span><br>
                        Expansion: <span id="preview-operational-expansion">-</span>
                    </div>
                </div>
            </div>

            <% if @solar_system %>
            <div class="tool-section">
                <h3>üìä SYSTEM STATS</h3>
                <div style="font-size: 11px; color: #888;">
                    <div style="margin: 5px 0;">
                        <span>Total Bodies:</span>
                        <span style="color: #0f0; float: right;"><%= @celestial_bodies.count %></span>
                    </div>
                    <div style="margin: 5px 0;">
                        <span>With Atmosphere:</span>
                        <span style="color: #0f0; float: right;"><%= @celestial_bodies.joins(:atmosphere).count %></span>
                    </div>
                    <div style="margin: 5px 0;">
                        <span>With Biosphere:</span>
                        <span style="color: #0f0; float: right;"><%= @celestial_bodies.joins(:biosphere).count %></span>
                    </div>
                    <div style="margin: 5px 0;">
                        <span>With Hydrosphere:</span>
                        <span style="color: #0f0; float: right;"><%= @celestial_bodies.joins(:hydrosphere).count %></span>
                    </div>
                </div>
            </div>
            <% end %>
        </div>
        
        <!-- Main Content: Body List -->
        <div style="padding: 20px; overflow-y: auto; background: #0a0a0a; grid-column: 2;">
            <% if @celestial_bodies.any? %>
                <% @celestial_bodies.each do |body| %>
                    <div class="tool-section" style="margin-bottom: 15px; position: relative;">
                        <h3 style="display: flex; justify-content: space-between; align-items: center;">
                            <span><%= body.name.upcase %></span>
                            <span style="font-size: 11px; color: #888;"><%= body.type&.titleize || 'Unknown' %></span>
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 10px 0;">
                            <div class="data-row">
                                <span class="data-label">Size:</span>
                                <span class="data-value"><%= number_with_precision(body.size, precision: 2) %></span>
                            </div>
                            <div class="data-row">
                                <span class="data-label">Gravity:</span>
                                <span class="data-value"><%= number_with_precision(body.gravity, precision: 2) %>g</span>
                            </div>
                            <% if body.atmosphere %>
                            <div class="data-row">
                                <span class="data-label">Atmosphere:</span>
                                <span class="data-value" style="color: #0ff;">Present</span>
                            </div>
                            <% end %>
                            <% if body.biosphere %>
                            <div class="data-row">
                                <span class="data-label">Biosphere:</span>
                                <span class="data-value" style="color: #0f0;">Active</span>
                            </div>
                            <% end %>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #333;">
                            <%= button_to '‚ñ∂Ô∏è Run Simulation', admin_simulation_run_path(body.id), method: :post, style: 'padding: 8px 15px; background: #0f0; color: #000; border: none; cursor: pointer; font-family: "Courier New", monospace; flex: 1;' %>
                            
                            <%= link_to 'üñ•Ô∏è Monitor', "/admin/celestial_bodies/#{body.id}/monitor", style: 'padding: 8px 15px; background: #222; color: #0ff; border: 1px solid #0ff; text-decoration: none; text-align: center; font-family: "Courier New", monospace; flex: 1; display: block;' %>
                            
                            <%= link_to 'üëÅÔ∏è View', celestial_body_path(body), style: 'padding: 8px 15px; background: #222; color: #0ff; border: 1px solid #0ff; text-decoration: none; text-align: center; font-family: "Courier New", monospace; flex: 1; display: block;' %>
                        </div>
                    </div>
                <% end %>
            <% else %>
                <div class="tool-section">
                    <h3 style="color: #f00;">‚ö†Ô∏è NO CELESTIAL BODIES FOUND</h3>
                    <p style="color: #888; margin-top: 10px;">
                        No celestial bodies exist in the database. Please seed the database or create bodies manually.
                    </p>
                    <button class="tool-button" onclick="window.location.href='/celestial_bodies/new'" style="margin-top: 10px;">
                        ‚ûï Create New Body
                    </button>
                </div>
            <% end %>
        </div>
        
        <!-- Right Panel: Simulation Log -->
        <div id="toolPanel" style="border-left: 2px solid #0f0; border-right: none;">
            <div class="tool-section">
                <h3>üìú SIMULATION LOG</h3>
                <div id="simulationLog" style="max-height: 400px; overflow-y: auto; font-size: 11px; color: #0f0; font-family: 'Courier New', monospace;">
                    <% if flash[:notice] %>
                        <div style="color: #0f0; margin: 5px 0; padding: 5px; background: #003300; border-left: 2px solid #0f0;">
                            ‚úì <%= flash[:notice] %>
                        </div>
                    <% end %>
                    <% if flash[:alert] %>
                        <div style="color: #f00; margin: 5px 0; padding: 5px; background: #330000; border-left: 2px solid #f00;">
                            ‚úó <%= flash[:alert] %>
                        </div>
                    <% end %>
                    <div style="color: #888; margin-top: 10px;">
                        System ready for simulation commands...
                    </div>
                </div>
            </div>
            
            <div class="tool-section">
                <h3>üéØ QUICK ACTIONS</h3>
                <%= link_to 'üìã All Bodies', celestial_bodies_path, class: 'tool-button', style: 'display: block; text-align: center; text-decoration: none; color: #0f0;' %>
                <%= link_to 'üè† Admin Dashboard', '/admin', class: 'tool-button', style: 'display: block; text-align: center; text-decoration: none; color: #0f0;' %>
            </div>
        </div>
    </div>

    <script>
        function advanceTime(ticks) {
            alert(`Time advance feature coming soon!\nWill advance ${ticks} tick(s)`);
            // TODO: Implement time advancement API
        }
        
        function resetAllSpheres() {
            if (confirm('Reset all sphere data to base values?\nThis will affect all celestial bodies.')) {
                alert('Reset sphere feature coming soon!');
                // TODO: Implement sphere reset API
            }
        }
        
        function exportSimulationData() {
            const data = {
                system: '<%= @solar_system&.name %>',
                timestamp: new Date().toISOString(),
                bodies: <%= raw @celestial_bodies.map { |b| 
                    {
                        name: b.name,
                        type: b.type,
                        size: b.size,
                        gravity: b.gravity,
                        has_atmosphere: b.atmosphere.present?,
                        has_biosphere: b.biosphere.present?,
                        has_hydrosphere: b.hydrosphere.present?
                    }
                }.to_json %>
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'simulation-data-export.json';
            a.click();
        }

        // AI Priority Controls
        document.addEventListener('DOMContentLoaded', function() {
            const criticalSlider = document.getElementById('critical-slider');
            const operationalSlider = document.getElementById('operational-slider');
            const criticalValue = document.getElementById('critical-value');
            const operationalValue = document.getElementById('operational-value');
            const updateBtn = document.getElementById('update-priorities-btn');
            const resetBtn = document.getElementById('reset-priorities-btn');
            const previewDiv = document.getElementById('priority-preview');

            // Update value displays when sliders change
            criticalSlider.addEventListener('input', function() {
                criticalValue.textContent = parseFloat(this.value).toFixed(1) + 'x';
                updatePreview();
            });

            operationalSlider.addEventListener('input', function() {
                operationalValue.textContent = parseFloat(this.value).toFixed(1) + 'x';
                updatePreview();
            });

            // Update priorities via AJAX
            updateBtn.addEventListener('click', function() {
                const criticalMultiplier = parseFloat(criticalSlider.value);
                const operationalMultiplier = parseFloat(operationalSlider.value);

                fetch('/admin/simulation/update_ai_priorities', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({
                        critical_multiplier: criticalMultiplier,
                        operational_multiplier: operationalMultiplier
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('‚úÖ AI priorities updated successfully!', 'success');
                        updatePreview();
                    } else {
                        showNotification('‚ùå Failed to update AI priorities', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error updating priorities:', error);
                    showNotification('‚ùå Error updating AI priorities', 'error');
                });
            });

            // Reset priorities to default
            resetBtn.addEventListener('click', function() {
                if (confirm('Reset AI priorities to default values (1.0x)?')) {
                    fetch('/admin/simulation/reset_ai_priorities', {
                        method: 'POST',
                        headers: {
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            criticalSlider.value = 1.0;
                            operationalSlider.value = 1.0;
                            criticalValue.textContent = '1.0x';
                            operationalValue.textContent = '1.0x';
                            showNotification('üîÑ AI priorities reset to default!', 'success');
                            updatePreview();
                        } else {
                            showNotification('‚ùå Failed to reset AI priorities', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error resetting priorities:', error);
                        showNotification('‚ùå Error resetting AI priorities', 'error');
                    });
                }
            });

            // Update priority preview
            function updatePreview() {
                const criticalMult = parseFloat(criticalSlider.value);
                const operationalMult = parseFloat(operationalSlider.value);

                // Calculate effective priorities (simplified preview)
                document.getElementById('preview-critical-life-support').textContent = Math.round(1000 * criticalMult);
                document.getElementById('preview-critical-atmospheric').textContent = Math.round(900 * criticalMult);
                document.getElementById('preview-critical-debt').textContent = Math.round(800 * criticalMult);
                document.getElementById('preview-operational-resources').textContent = Math.round(500 * operationalMult);
                document.getElementById('preview-operational-construction').textContent = Math.round(300 * operationalMult);
                document.getElementById('preview-operational-expansion').textContent = Math.round(100 * operationalMult);

                previewDiv.style.display = 'block';
            }

            // Show notification in simulation log
            function showNotification(message, type) {
                const logDiv = document.getElementById('simulationLog');
                const notification = document.createElement('div');
                notification.style.cssText = `
                    margin: 5px 0;
                    padding: 5px;
                    border-left: 2px solid ${type === 'success' ? '#0f0' : '#f00'};
                    background: ${type === 'success' ? '#003300' : '#330000'};
                    color: ${type === 'success' ? '#0f0' : '#f00'};
                `;
                notification.textContent = message;
                logDiv.insertBefore(notification, logDiv.firstChild);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }

            // Initialize preview on page load
            updatePreview();
        });
    </script>
</body>
</html>
