<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="<%= form_authenticity_token %>">
    <title>Admin Monitor - <%= @celestial_body.name %></title>
    <%= stylesheet_link_tag 'admin/monitor', media: 'all' %>
    <%= javascript_include_tag 'tileset_loader' %>
</head>
<body>
    <div id="mainContainer">
        <!-- Header -->
        <div id="header">
            <h1 id="planetName"><%= @celestial_body.name %> - ADMIN MONITOR</h1>
            <div id="planetInfo">
                <%= @celestial_body.type %> | 
                Radius: <%= number_to_human(@celestial_body.radius, precision: 2) %> m | 
                Gravity: <%= number_with_precision(@celestial_body.gravity, precision: 3) %>g |
                Temp: <%= number_with_precision(@celestial_body.surface_temperature, precision: 1) %>K
            </div>
        </div>
        
        <!-- Left Panel: AI Mission Controls -->
        <div id="toolPanel">
            <!-- Mission Control Section -->
            <div class="tool-section">
                <h3>AI MISSION CONTROL</h3>
                <button class="tool-button" data-test="resource_extraction">
                    ‚õèÔ∏è Test Resource Extraction
                </button>
                <button class="tool-button" data-test="base_construction">
                    üèóÔ∏è Test Base Construction
                </button>
                <button class="tool-button" data-test="isru_pipeline">
                    üè≠ Test ISRU Pipeline
                </button>
                <button class="tool-button" data-test="gcc_bootstrap">
                    üöÄ Test GCC Bootstrap
                </button>
                <button class="tool-button" onclick="window.location.href='/celestial_bodies/<%= @celestial_body.id %>'">
                    üëÅÔ∏è View Public Page
                </button>
                <button class="tool-button" onclick="window.location.href='/admin/celestial_bodies/<%= @celestial_body.id %>/edit'">
                    ‚öôÔ∏è Edit Celestial Body
                </button>
            </div>
            
            <!-- Management Tools Section -->
            <div class="tool-section">
                <h3>ADMIN TOOLS</h3>
                <button class="tool-button" onclick="window.location.href='/admin/celestial_bodies/<%= @celestial_body.id %>/edit'">
                    ‚öôÔ∏è Edit Celestial Body Properties
                </button>
                <button class="tool-button" onclick="window.location.href='/celestial_bodies/<%= @celestial_body.id %>'">
                    üëÅÔ∏è View Public Page
                </button>
            </div>
            
            <!-- Active Missions Section -->
            <div class="tool-section">
                <h3>ACTIVE MISSIONS</h3>
                <div id="missionList">
                    <% @ai_missions.each do |mission| %>
                        <div class="mission-item <%= mission[:status] %>">
                            <div class="mission-header">
                                <span class="mission-type"><%= mission[:type] %></span>
                                <span class="mission-status"><%= mission[:status].upcase %></span>
                            </div>
                            <div class="mission-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: <%= mission[:progress] %>%"></div>
                                </div>
                                <span class="progress-text"><%= mission[:progress] %>%</span>
                            </div>
                        </div>
                    <% end %>
                </div>
            </div>
            
            <!-- View Layers Section -->
            <div class="tool-section">
                <h3>MAP LAYERS</h3>
                <div class="layer-selector">
                    <button class="layer-btn active" data-layer="terrain">Terrain</button>
                    <button class="layer-btn" data-layer="water">Water</button>
                    <button class="layer-btn" data-layer="biomes">Biomes</button>
                    <button class="layer-btn" data-layer="features">Features</button>
                    <button class="layer-btn" data-layer="temperature">Temp</button>
                    <button class="layer-btn" data-layer="rainfall">Rainfall</button>
                    <button class="layer-btn" data-layer="resources">Resources</button>
                </div>
            </div>
            
            <!-- Geological Features -->
            <% if @geological_features.any? %>
                <div class="tool-section">
                    <h3>GEOLOGICAL FEATURES</h3>
                    <div class="feature-list">
                        <% @geological_features.take(5).each do |feature| %>
                            <div class="feature-item">
                                <strong><%= feature[:name] %></strong>
                                <span class="feature-type"><%= feature[:type] %></span>
                            </div>
                        <% end %>
                    </div>
                </div>
            <% end %>
        </div>
        
        <!-- Center Panel: Planetary Map -->
        <div id="canvasWrapper">
            <div id="mapOverlay">
                <div id="mapTitle"><%= @celestial_body.name %> - PLANETARY MAP</div>
                <div id="mapControls">
                    <div class="control-group">
                        <label>Zoom: <span id="zoomValue" class="value-display">1.0x</span></label>
                        <input type="range" id="zoom" min="0.5" max="4" step="0.1" value="1">
                    </div>
                </div>
            </div>
            <canvas id="planetCanvas" width="800" height="400"></canvas>
            <div id="featureTooltip" class="hidden">
                <div id="tooltipContent"></div>
            </div>
        </div>
        
        <!-- Right Panel: Sphere Data -->
        <div id="dataPanel">
            <!-- Atmosphere Section -->
            <div class="data-section">
                <h3>ATMOSPHERE</h3>
                <% if @celestial_body.atmosphere %>
                    <div class="data-row">
                        <span class="data-label">Pressure:</span>
                        <span class="data-value" id="atmo-pressure">
                            <%= number_with_precision(@celestial_body.atmosphere.pressure, precision: 4) %> bar
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Temperature:</span>
                        <span class="data-value" id="atmo-temp">
                            <%= number_with_precision(@celestial_body.atmosphere.temperature, precision: 1) %> K
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Total Liquid Mass:</span>
                        <span class="data-value" id="atmo-mass">
                            <%= number_to_human(@celestial_body.atmosphere.total_atmospheric_mass || 0, precision: 2) %> kg
                        </span>
                    </div>
                    
                    <!-- Composition -->
                    <% composition = @celestial_body.atmospheric_composition %>
                    <% if composition.any? %>
                        <h4 class="subsection">Composition:</h4>
                        <% composition.each do |gas, percentage| %>
                            <div class="data-row">
                                <span class="data-label"><%= gas %>:</span>
                                <span class="data-value"><%= number_with_precision(percentage, precision: 2) %>%</span>
                            </div>
                        <% end %>
                    <% end %>
                <% else %>
                    <div class="data-row">
                        <span class="data-value warning">Not Present</span>
                    </div>
                <% end %>
            </div>
            
            <!-- Hydrosphere Section -->
            <div class="data-section">
                <h3>HYDROSPHERE</h3>
                <% if @celestial_body.hydrosphere %>
                    <div class="data-row">
                        <span class="data-label">Liquid Coverage:</span>
                        <span class="data-value" id="hydro-coverage">
                            <%= number_with_precision(@celestial_body.hydrosphere.water_coverage || 0, precision: 1) %>%
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Ocean Mass:</span>
                        <span class="data-value" id="hydro-ocean">
                            <%= number_to_human(oceans_value(@celestial_body.hydrosphere.oceans), precision: 2) %> kg
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Ice Mass:</span>
                        <span class="data-value" id="hydro-ice">
                            <%= number_to_human(ice_caps_value(@celestial_body.hydrosphere.ice_caps), precision: 2) %> kg
                        </span>
                    </div>
                <% else %>
                    <div class="data-row">
                        <span class="data-value warning">Not Present</span>
                    </div>
                <% end %>
            </div>
            
            <!-- Subsurface Hydrosphere Section -->
            <div class="data-section">
                <h3>SUBSURFACE HYDROSPHERE</h3>
                <% if @celestial_body.subsurface_hydrosphere %>
                    <div class="data-row">
                        <span class="data-label">Deep Ocean:</span>
                        <span class="data-value" id="subsurface-type">Liquid Layer</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Composition:</span>
                        <span class="data-value" id="subsurface-composition">
                            <%= @celestial_body.subsurface_hydrosphere.composition&.map { |k,v| "#{k}: #{v}%" }&.join(', ') || 'Unknown' %>
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Temperature:</span>
                        <span class="data-value" id="subsurface-temp">
                            <%= number_with_precision(@celestial_body.subsurface_hydrosphere.temperature, precision: 1) %> K
                        </span>
                    </div>
                <% else %>
                    <div class="data-row">
                        <span class="data-value warning">Not Present</span>
                    </div>
                <% end %>
            </div>
            
            <!-- Cryosphere Section -->
            <div class="data-section">
                <h3>CRYOSPHERE</h3>
                <% if @celestial_body.cryosphere %>
                    <div class="data-row">
                        <span class="data-label">Shell Type:</span>
                        <span class="data-value" id="cryo-type">
                            <%= @celestial_body.cryosphere.shell_type&.humanize || 'Unknown' %>
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Thickness:</span>
                        <span class="data-value" id="cryo-thickness">
                            <%= @celestial_body.cryosphere.thickness ? "#{number_with_precision(@celestial_body.cryosphere.thickness / 1000.0, precision: 1)} km" : 'Unknown' %>
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Artificial:</span>
                        <span class="data-value" id="cryo-artificial">
                            <%= @celestial_body.cryosphere.artificial ? 'Yes' : 'No' %>
                        </span>
                    </div>
                <% else %>
                    <div class="data-row">
                        <span class="data-value warning">Not Present</span>
                    </div>
                <% end %>
            </div>
            
            <!-- Biosphere Section -->
            <div class="data-section">
                <h3>BIOSPHERE</h3>
                <% if @celestial_body.biosphere %>
                    <div class="data-row">
                        <span class="data-label">Biodiversity:</span>
                        <span class="data-value" id="bio-diversity">
                            <%= number_with_precision((@celestial_body.biosphere.biodiversity_index || 0) * 100, precision: 1) %>%
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="bio-diversity-bar" 
                             style="width: <%= (@celestial_body.biosphere.biodiversity_index || 0) * 100 %>%"></div>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Habitability:</span>
                        <span class="data-value" id="bio-habitability">
                            <%= number_with_precision((@celestial_body.biosphere.habitable_ratio || 0) * 100, precision: 1) %>%
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="bio-habitability-bar" 
                             style="width: <%= (@celestial_body.biosphere.habitable_ratio || 0) * 100 %>%"></div>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Life Forms:</span>
                        <span class="data-value" id="bio-lifeforms">
                            <%= @celestial_body.biosphere.life_forms.count %>
                        </span>
                    </div>
                <% else %>
                    <div class="data-row">
                        <span class="data-value warning">Not Present</span>
                    </div>
                <% end %>
            </div>
            
            <!-- Geosphere Section -->
            <% if @celestial_body.geosphere %>
                <div class="data-section">
                    <h3>GEOSPHERE</h3>
                    <div class="data-row">
                        <span class="data-label">Geological Activity:</span>
                        <span class="data-value" id="geo-activity">
                            <%= number_with_precision((@celestial_body.geosphere.geological_activity || 0) * 100, precision: 1) %>%
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Tectonic Active:</span>
                        <span class="data-value" id="geo-tectonic">
                            <%= @celestial_body.geosphere.tectonic_activity ? 'Yes' : 'No' %>
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Core Mass:</span>
                        <span class="data-value" id="geo-core">
                            <%= number_to_human(@celestial_body.geosphere.total_core_mass || 0, precision: 2) %> kg
                        </span>
                    </div>
                </div>
            <% end %>
        </div>
        
        <!-- Bottom Panel: Console -->
        <div id="console">
            <div class="console-line info">&gt; Admin monitoring system initialized for <%= @celestial_body.name %></div>
            <div class="console-line info">&gt; Sphere data loaded: 
                <%= @sphere_summary.select { |k, v| v }.keys.join(', ') %>
            </div>
            <div class="console-line info">&gt; Ready for AI Manager testing operations</div>
        </div>
    </div>

    <script>
        // Admin monitoring interface JavaScript
        const planetId = <%= @celestial_body.id %>;
        let updateInterval = null;

        // Initialize monitoring
        document.addEventListener('DOMContentLoaded', function() {
            setupAITestButtons();
            setupLayerToggles();
            updateLayerButtons(); // Initialize button states
            setupZoomControl();
            startDataPolling();
            renderTerrainMap(); // Add terrain rendering
            logConsole('System initialized', 'info');
        });

        // Simple terrain map renderer
        function renderTerrainMap() {
            const canvas = document.getElementById('planetCanvas');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }

            // Load terrain data from geosphere or properties
            <%
              terrain_map_data = @celestial_body&.geosphere&.terrain_map
              terrain_json = terrain_map_data ? terrain_map_data.to_json : 'null'
            %>
            const terrainData = <%= raw terrain_json %>;
            if (!terrainData && <%= @celestial_body&.properties&.dig('terrain_grid').present?.to_s %>) {
                <%
                  props_data = { grid: @celestial_body.properties['terrain_grid'], width: @celestial_body.properties['grid_width'], height: @celestial_body.properties['grid_height'], biome_counts: @celestial_body.properties['biome_counts'] }
                  props_json = props_data.to_json
                %>
                terrainData = <%= raw props_json %>;
            }

            console.log('Celestial body:', <%= @celestial_body.name.to_json %>);
            console.log('Geosphere present:', <%= (@celestial_body.geosphere.present? rescue false).to_json %>);
            console.log('Terrain map in geosphere:', <%= (@celestial_body.geosphere&.terrain_map.present? rescue false).to_json %>);
            console.log('Terrain grid in properties:', <%= (@celestial_body.properties&.dig('terrain_grid').present? rescue false).to_json %>);
            console.log('Terrain data loaded:', terrainData);

            if (!terrainData || (!terrainData.grid && !terrainData.terrain_grid)) {
                console.warn('No terrain data available - displaying message on canvas');
                logConsole('No terrain data available for rendering', 'warning');
                
                // Clear canvas and show message
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw message
                ctx.fillStyle = '#ffffff';
                ctx.font = '16px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('NO TERRAIN DATA', canvas.width / 2, canvas.height / 2 - 20);
                ctx.fillText('AVAILABLE', canvas.width / 2, canvas.height / 2 + 10);
                ctx.fillText('Generate terrain map to view planetary surface', canvas.width / 2, canvas.height / 2 + 40);
                
                return;
            }

            const ctx = canvas.getContext('2d');
            const grid = terrainData.grid || terrainData.terrain_grid;
            const width = terrainData.width || grid[0]?.length || 0;
            const height = terrainData.height || grid.length;

            if (width === 0 || height === 0) {
                console.error('Invalid terrain dimensions');
                return;
            }

            // Set canvas size based on terrain data
            const tileSize = 8; // 8px per tile
            canvas.width = width * tileSize;
            canvas.height = height * tileSize;

            // Color map for terrain types (matches SampleTerrainGenerator)
            const colors = {
                ocean: '#0066cc',
                deep_sea: '#003366',
                arctic: '#ffffff',
                tundra: '#666666',
                grasslands: '#66cc66',
                plains: '#99cc99',
                forest: '#006600',
                jungle: '#004400',
                desert: '#ffcc66',
                mountains: '#8b4513',
                rock: '#666666',
                boreal: '#8b7355',
                swamp: '#4a5d23'
            };

            // Calculate climate zones using TerraSim biosphere logic
            function calculateClimateZones(tempK, pressureBar) {
                // Simplified TerraSim calculations
                const Ts = tempK; // Surface temperature
                const Tp = Ts - 75 / (1 + 5 * pressureBar); // Polar temperature (TerraSim formula)
                const Tt = Ts * 1.1; // Tropical temperature
                
                let iceLat = 0; // Ice latitude in degrees
                let habRatio = 0; // Habitable ratio
                
                if (Tt > 273 && Tp < 273) {
                    // Partial ice coverage
                    habRatio = Math.pow((Tt - 273) / (Tt - Tp), 0.666667);
                    iceLat = Math.asin(habRatio) * 180 / Math.PI; // Convert to degrees
                } else if (Tt < 273) {
                    // Completely frozen
                    habRatio = 0;
                    iceLat = 90;
                } else {
                    // No ice
                    habRatio = 1;
                    iceLat = 0;
                }
                
                return {
                    surfaceTemp: Ts,
                    polarTemp: Tp,
                    tropicalTemp: Tt,
                    iceLatitude: iceLat,
                    habitableRatio: habRatio,
                    // Climate zone boundaries
                    polarZone: iceLat,
                    temperateZone: Math.max(iceLat + 30, 45),
                    tropicalZone: Math.max(iceLat + 60, 75)
                };
            }
            
            // Clear canvas
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Render each tile
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const terrainType = grid[y][x];

                    // Determine final color based on active layers
                    let finalColor = '#000000'; // Default to black for non-matching terrain

                    // Start with elevation-based gray scale if terrain layer is active
                    let baseColor = null;
                    if (visibleLayers.has('terrain')) {
                        const elevation = terrainElevation[terrainType] || 0.5; // Default to medium elevation
                        const grayValue = Math.floor(elevation * 255);
                        baseColor = `rgb(${grayValue}, ${grayValue}, ${grayValue})`;
                        finalColor = baseColor;
                    }

                    // Overlay layer colors on top of base color for terrains that match active layers
                    if (visibleLayers.size > 0) {
                        for (const [layerName, overlay] of Object.entries(layerOverlays)) {
                            if (visibleLayers.has(layerName) && overlay.terrainColors[terrainType]) {
                                let overlayColor = overlay.terrainColors[terrainType];
                                
                                // Handle function-based colors (for climate-aware desert rendering)
                                if (typeof overlayColor === 'function') {
                                    // Calculate approximate latitude based on y position (0 = north pole, height-1 = south pole)
                                    const latitude = ((y / (height - 1)) - 0.5) * 180; // Convert to degrees (-90 to +90)
                                    overlayColor = overlayColor(latitude);
                                }
                                
                                console.log(`Layer ${layerName} overlay applied to ${terrainType}: ${overlayColor}`);
                                finalColor = overlayColor;
                                break; // First matching layer wins
                            }
                        }
                    }

                    // If no layers are active and no base color, show base terrain colors
                    if (!baseColor && visibleLayers.size === 0) {
                        finalColor = colors[terrainType] || '#999999';
                    }

                    ctx.fillStyle = finalColor;
                    ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);

                    // Add subtle border for tile definition
                    ctx.strokeStyle = '#333333';
                    ctx.lineWidth = 0.5;
                    ctx.strokeRect(x * tileSize, y * tileSize, tileSize, tileSize);
                }
            }

            const uniqueTerrains = grid.flat().filter((v, i, a) => a.indexOf(v) === i);
            console.log(`Rendered ${width}x${height} terrain map with ${Object.keys(colors).length} terrain types`);
            console.log('Terrain types found:', uniqueTerrains);
            logConsole(`Terrain map rendered: ${width}x${height} (${uniqueTerrains.length} unique terrain types: ${uniqueTerrains.join(', ')})`, 'success');
        }

        // Setup AI test buttons
        function setupAITestButtons() {
            document.querySelectorAll('.tool-button[data-test]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const testType = this.dataset.test;
                    runAITest(testType);
                });
            });
        }

        // Run AI Manager test
        function runAITest(testType) {
            logConsole(`Starting AI test: ${testType}`, 'info');
            
            fetch(`/admin/celestial_bodies/${planetId}/run_ai_test`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
                },
                body: JSON.stringify({ test_type: testType })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    logConsole(data.message, 'success');
                    logConsole(`Test completed: ${JSON.stringify(data)}`, 'info');
                } else {
                    logConsole(`Test failed: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                logConsole(`Error running test: ${error.message}`, 'error');
            });
        }

        // Setup zoom control
        function setupZoomControl() {
            const zoomInput = document.getElementById('zoom');
            const zoomValue = document.getElementById('zoomValue');
            const canvas = document.getElementById('planetCanvas');
            const canvasWrapper = document.getElementById('canvasWrapper');
            
            zoomInput.addEventListener('input', function() {
                const zoom = parseFloat(this.value);
                zoomValue.textContent = zoom.toFixed(1) + 'x';
                
                // Use CSS transform to zoom the canvas
                if (zoom === 1.0) {
                    canvas.style.transform = 'none';
                    canvasWrapper.style.overflow = 'auto'; // Allow scrolling for large maps
                } else {
                    canvas.style.transform = `scale(${zoom})`;
                    canvas.style.transformOrigin = 'top left';
                    canvasWrapper.style.overflow = 'auto'; // Enable scrolling when zoomed
                }
            });
            
            // Initialize at 1.0x
            zoomValue.textContent = '1.0x';
            canvas.style.transform = 'none';
            canvasWrapper.style.overflow = 'auto';
        }

        // Start polling for data updates
        function startDataPolling() {
            updateInterval = setInterval(updateSphereData, 5000); // Update every 5 seconds
        }

        // Update sphere data from server
        function updateSphereData() {
            fetch(`/admin/celestial_bodies/${planetId}/sphere_data`)
                .then(response => response.json())
                .then(data => {
                    // Update atmosphere data
                    if (data.atmosphere.pressure !== undefined) {
                        updateElement('atmo-pressure', `${data.atmosphere.pressure.toFixed(4)} bar`);
                        updateElement('atmo-temp', `${data.atmosphere.temperature.toFixed(1)} K`);
                        updateElement('atmo-mass', formatMass(data.atmosphere.total_mass));
                    }
                    
                    // Update hydrosphere data
                    if (data.hydrosphere.water_coverage !== undefined) {
                        updateElement('hydro-coverage', `${data.hydrosphere.water_coverage.toFixed(1)}%`);
                        updateElement('hydro-ocean', formatMass(data.hydrosphere.ocean_mass));
                        updateElement('hydro-ice', formatMass(data.hydrosphere.ice_mass));
                    }
                    
                    // Update biosphere data
                    if (data.biosphere.biodiversity_index !== undefined) {
                        updateElement('bio-diversity', `${data.biosphere.biodiversity_index.toFixed(1)}%`);
                        updateProgressBar('bio-diversity-bar', data.biosphere.biodiversity_index);
                        updateElement('bio-habitability', `${data.biosphere.habitable_ratio.toFixed(1)}%`);
                        updateProgressBar('bio-habitability-bar', data.biosphere.habitable_ratio);
                        updateElement('bio-lifeforms', data.biosphere.life_forms_count);
                    }
                    
                    // Update geosphere data
                    if (data.geosphere.geological_activity !== undefined) {
                        updateElement('geo-activity', `${data.geosphere.geological_activity}/100`);
                        updateElement('geo-tectonic', data.geosphere.tectonic_active ? 'Yes' : 'No');
                        updateElement('geo-volcano', data.geosphere.volcanic_activity);
                    }
                })
                .catch(error => {
                    console.error('Error updating sphere data:', error);
                });
        }

        // Helper: Update element text content
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        }

        // Helper: Update progress bar width
        function updateProgressBar(id, percentage) {
            const element = document.getElementById(id);
            if (element) element.style.width = `${percentage}%`;
        }

        // Helper: Format mass for display
        function formatMass(mass) {
            if (mass > 1e18) return `${(mass / 1e18).toFixed(2)} Eg`;
            if (mass > 1e15) return `${(mass / 1e15).toFixed(2)} Pg`;
            if (mass > 1e12) return `${(mass / 1e12).toFixed(2)} Tg`;
            if (mass > 1e9) return `${(mass / 1e9).toFixed(2)} Gg`;
            return `${mass.toFixed(2)} kg`;
        }

        // Log to console panel
        function logConsole(message, type = 'info') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] > ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
            
            // Keep only last 50 messages
            while (console.children.length > 50) {
                console.removeChild(console.firstChild);
            }
        }

        // Setup layer toggles
        function setupLayerToggles() {
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const layer = this.dataset.layer;
                    toggleLayer(layer);
                    updateLayerButtons();
                });
            });
        }

        // Layer visibility state
        let visibleLayers = new Set(['terrain']); // Start with base terrain only

        // TerraSim-style climate zone calculations
        const planetTemp = <%= @celestial_body.atmosphere&.temperature || @celestial_body.surface_temperature || 288 %>; // Global surface temperature in K
        const planetPressure = <%= @celestial_body.atmosphere&.pressure || 1.0 %>; // Atmospheric pressure in bar
        
        const climate = calculateClimateZones(planetTemp, planetPressure);

        // Layer overlay colors (complete replacement with terrain-specific shades)
        const layerOverlays = {
            water: {
                terrainColors: {
                    'ocean': '#0088ff',    // Bright blue for surface water
                    'deep_sea': '#004488'  // Darker blue for deep ocean
                }
            },
            biomes: {
                terrainColors: {
                    'forest': '#00ff00',   // Bright green for forests
                    'jungle': '#00dd00',   // Slightly darker for dense jungle
                    'grasslands': '#88ff88', // Lighter green for grasslands
                    'plains': '#aaffaa',   // Light green for plains
                    'swamp': '#66aa66',    // Muted green for swamps
                    'boreal': '#448844',   // Dark green for boreal forests/taiga
                    'arctic': '#ffffff',   // White for polar ice caps (cryosphere biome)
                    'desert': function(lat) { // Climate-based desert coloring
                        // Use latitude to determine desert temperature type
                        // Deserts near poles are cold (white/beige), equatorial deserts are warm (yellow)
                        const absLat = Math.abs(lat);
                        if (absLat > climate.iceLatitude + 20) {
                            return '#ffeedd'; // Cold desert (beige-white)
                        } else {
                            return '#ffdd44'; // Warm desert (yellow)
                        }
                    }
                }
            },
            features: {
                terrainColors: {
                    'rock': '#696969'     // Gray for bare rock
                }
            },
            temperature: {
                terrainColors: {
                    'desert': '#ff6600',  // Red-orange for hot deserts (SimEarth style)
                    'rock': '#0088ff'     // Blue for cold rocky highlands
                }
            },
            rainfall: {
                terrainColors: {
                    'jungle': '#0066ff',   // Dark blue for high rainfall tropics
                    'swamp': '#0044ff',   // Very dark blue for wetlands
                    'forest': '#4488ff',  // Medium blue for moderate rainfall forests
                    'boreal': '#88aaff',  // Light blue for temperate rainfall
                    'desert': '#ffff00'   // Yellow for arid/low rainfall
                }
            },
            resources: {
                terrainColors: {
                    'rock': '#ffd700',    // Gold for mineral-rich rock
                    'desert': '#daa520'   // Darker gold for desert minerals
                }
            }
        };

        // Toggle layer visibility
        function toggleLayer(layerName) {
            if (layerName === 'terrain') {
                // Terrain is always visible as base layer
                return;
            }

            if (visibleLayers.has(layerName)) {
                visibleLayers.delete(layerName);
            } else {
                visibleLayers.add(layerName);
            }

            renderTerrainMap(); // Re-render with new layer state
        }

        // Update button active states
        function updateLayerButtons() {
            document.querySelectorAll('.layer-btn').forEach(btn => {
                const layer = btn.dataset.layer;
                if (layer === 'terrain' || visibleLayers.has(layer)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }




        // Create a new sphere
        function createSphere(sphereType) {
            logConsole(`Creating ${sphereType}...`, 'info');
            
            fetch(`/admin/celestial_bodies/${planetId}/spheres`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
                },
                body: JSON.stringify({ 
                    sphere_type: sphereType,
                    sphere: { 
                        temperature: sphereType.includes('hydro') ? 300 : 200,
                        pressure: sphereType === 'atmosphere' ? 1.0 : 0,
                        thickness: sphereType === 'cryosphere' ? 10000 : null
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    logConsole(`${sphereType} created successfully`, 'success');
                    location.reload(); // Refresh to show new sphere
                } else {
                    logConsole(`Failed to create ${sphereType}: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                logConsole(`Error creating ${sphereType}: ${error.message}`, 'error');
            });
        }

        // Edit an existing sphere
        function editSphere(sphereId, sphereType) {
            logConsole(`Editing ${sphereType}...`, 'info');
            // For now, redirect to a simple edit form
            // In a full implementation, this would open a modal
            window.location.href = `/admin/celestial_bodies/${planetId}/spheres/${sphereId}/edit?type=${sphereType}`;
        }

        // Delete a sphere
        function deleteSphere(sphereId, sphereType) {
            logConsole(`Deleting ${sphereType}...`, 'warning');
            
            fetch(`/admin/celestial_bodies/${planetId}/spheres/${sphereId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    logConsole(`${sphereType} deleted successfully`, 'success');
                    location.reload(); // Refresh to hide deleted sphere
                } else {
                    logConsole(`Failed to delete ${sphereType}: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                logConsole(`Error deleting ${sphereType}: ${error.message}`, 'error');
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (updateInterval) clearInterval(updateInterval);
        });

        // Initialize map on page load
        window.addEventListener('load', () => {
            renderTerrainMap();
        });
    </script>
</body>
</html>
