<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="<%= form_authenticity_token %>">
    <title>Admin Monitor - <%= @celestial_body.name %></title>
    <%= stylesheet_link_tag 'admin/monitor', media: 'all' %>
</head>
<body>
    <%# Data injection for JavaScript - no inline JS logic %>
    <script type="application/json" id="monitor-data">
    <%
      terrain_map_data = @celestial_body&.geosphere&.terrain_map
      
      # Determine which layers should be available based on planetary conditions
      has_hydrosphere = @celestial_body.hydrosphere.present? && @celestial_body.hydrosphere.water_coverage.to_f > 0
      has_biosphere = @celestial_body.biosphere.present?
      has_atmosphere = @celestial_body.atmosphere.present? && @celestial_body.atmosphere.pressure.to_f > 0
      
      monitor_data = {
        planet_id: @celestial_body.id,
        planet_name: @celestial_body.name,
        planet_type: @celestial_body.type,
        surface_temperature: @celestial_body.surface_temperature,
        atmosphere_temperature: @celestial_body.atmosphere&.temperature,
        atmosphere_pressure: @celestial_body.atmosphere&.pressure,
        atmospheric_composition: @celestial_body.atmospheric_composition,
        terrain_data: terrain_map_data,
        planet_data: {
          name: @celestial_body.name,
          type: @celestial_body.type,
          atmosphere: @celestial_body.atmosphere&.attributes,
          surface_temperature: @celestial_body.surface_temperature,
          temperature: @celestial_body.temperature,
          geological_activity: @celestial_body.geological_activity,
          gravity: @celestial_body.gravity,
          geosphere_attributes: @celestial_body.geosphere&.attributes,
          crust_composition: @celestial_body.geosphere&.crust_composition,
          liquid_name: (@celestial_body.respond_to?(:primary_liquid) ? @celestial_body.primary_liquid : nil) || 'H2O',
          water_coverage: @celestial_body.hydrosphere&.water_coverage || 0,
          has_biosphere: has_biosphere,
          has_hydrosphere: has_hydrosphere,
          has_atmosphere: has_atmosphere
        },
        geosphere_present: @celestial_body.geosphere.present?,
        biosphere_present: has_biosphere,
        hydrosphere_present: has_hydrosphere,
        atmosphere_present: has_atmosphere,
        terrain_map_present: @celestial_body.geosphere&.terrain_map.present?,
        # Layer availability flags
        available_layers: {
          terrain: true,
          water: has_hydrosphere,
          biomes: has_biosphere,
          features: has_biosphere,
          temperature: true,
          rainfall: has_hydrosphere && has_atmosphere,
          resources: true,
          civilization: true
        },
        # Civilization layer data
        civilization_features: @civilization_features
      }
    %>
    <%= raw monitor_data.to_json %>
    </script>

    <div class="admin-main-container" style="display: grid; grid-template-columns: 250px 1fr 320px; grid-template-rows: auto 1fr auto; min-height: 100vh;">
        <header class="admin-header" style="grid-column: 1 / span 3;">
            <h1 class="admin-title"><%= @celestial_body.name %> - ADMIN MONITOR</h1>
            <div class="admin-header-info">
                <%= @celestial_body.type %> |
                Radius: <%= number_to_human(@celestial_body.radius, precision: 2) %> m |
                Gravity: <%= number_with_precision(@celestial_body.gravity, precision: 3) %>g |
                Temp: <%= number_with_precision(@celestial_body.surface_temperature, precision: 1) %>K |
                <%= link_to '‚Üê Admin Dashboard', admin_root_path, style: 'color: #00d4ff; margin-left: 20px;' %>
            </div>
        </header>
        <aside class="admin-sidebar">         
            <!-- Navigation -->
            <div class="admin-tool-section">
                <h3>üéØ NAVIGATION</h3>
                <%= link_to 'üëÅÔ∏è View Public Page', celestial_body_path(@celestial_body), class: 'admin-tool-button' %>
                <%= link_to '‚öôÔ∏è Edit Properties', edit_admin_celestial_body_path(@celestial_body), class: 'admin-tool-button' %>
                <%= link_to 'üåç Celestial Bodies', admin_celestial_bodies_path, class: 'admin-tool-button' %>
            </div>
            
            <!-- Terrain Management -->
            <div class="admin-tool-section">
                <h3>üó∫Ô∏è TERRAIN</h3>
                <% if @celestial_body.geosphere&.terrain_map.nil? %>
                    <%= button_to 'üó∫Ô∏è Generate Terrain', generate_terrain_admin_celestial_body_path(@celestial_body), 
                                  method: :post, class: 'admin-tool-button', 
                                  data: { confirm: 'This will generate terrain data for this celestial body. Continue?' } %>
                <% else %>
                    <%= button_to 'üîÑ Regenerate Terrain', generate_terrain_admin_celestial_body_path(@celestial_body), 
                                  method: :post, class: 'admin-tool-button', 
                                  data: { confirm: 'This will regenerate terrain data, replacing existing data. Continue?' } %>
                <% end %>
            </div>
            

            
            <!-- Map Layers -->
            <div class="admin-tool-section">
                <h3>üó∫Ô∏è MAP LAYERS</h3>
                <div class="layer-selector">
                    <button class="layer-btn active" data-layer="terrain">Terrain</button>
                    <button class="layer-btn" data-layer="water">Hydrosphere</button>
                    <button class="layer-btn" data-layer="biomes">Biomes</button>
                    <button class="layer-btn" data-layer="features">Features</button>
                    <button class="layer-btn" data-layer="temperature">Temp</button>
                    <button class="layer-btn" data-layer="rainfall">Rainfall</button>
                    <button class="layer-btn" data-layer="resources">Resources</button>
                    <button class="layer-btn" data-layer="civilization">Civilization</button>
                </div>
            </div>

            <!-- Geological Features -->
            <% if @geological_features.any? %>
                <div class="admin-tool-section">
                    <h3>üèîÔ∏è GEOLOGICAL FEATURES</h3>
                    <div class="feature-list">
                        <% @geological_features.take(5).each do |feature| %>
                            <div class="feature-item">
                                <strong><%= feature[:name] %></strong>
                                <span class="feature-type"><%= feature[:type] %></span>
                            </div>
                        <% end %>
                    </div>
                </div>
            <% end %>
        </aside>
        <main class="admin-content" style="padding: 0 2rem;">
        <!-- Center Panel: Planetary Map -->
        <div id="canvasWrapper">
            <div id="mapOverlay">
                <div id="mapTitle"><%= @celestial_body.name %> - PLANETARY MAP</div>
            </div>
            <div id="canvasScroller">
                <div id="canvasContainer">
                    <canvas id="planetCanvas" width="800" height="400"></canvas>
                </div>
            </div>
            <div id="featureTooltip" class="hidden">
                <div id="tooltipContent"></div>
            </div>
            <div id="mapControls" style="width: 100%; display: flex; justify-content: flex-end; align-items: center; gap: 2rem; margin-top: 0.5rem; pointer-events: auto;">
                <div class="control-group">
                    <label>Zoom: <span id="zoomValue" class="value-display">1.0x</span></label>
                    <input type="range" id="zoom" min="0.5" max="4" step="0.1" value="1">
                </div>
                <div class="control-group">
                    <button id="resetViewBtn" class="admin-tool-button" title="Reset view to center" style="pointer-events: auto;">‚åÇ Reset</button>
                </div>
            </div>
        </div>
        </main>
        <!-- Right Panel: Data Panel -->
        <aside id="dataPanel" style="background: #101c2c; color: #fff; padding: 1.5rem 1rem; border-left: 1px solid #223;">
            <!-- Atmosphere Section -->
            <div class="data-section">
                <h3>ATMOSPHERE</h3>
                <% if @celestial_body.atmosphere %>
                    <div class="data-row">
                        <span class="data-label">Pressure:</span>
                        <span class="data-value" id="atmo-pressure">
                            <%= number_with_precision(@celestial_body.atmosphere.pressure, precision: 2) %> atm
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Temperature:</span>
                        <span class="data-value" id="atmo-temp">
                            <%= number_with_precision(@celestial_body.atmosphere.temperature, precision: 1) %> K
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Total Liquid Mass:</span>
                        <span class="data-value" id="atmo-mass">
                            <%= number_to_human(@celestial_body.atmosphere.total_atmospheric_mass || 0, precision: 2) %> kg
                        </span>
                    </div>
                    
                    <!-- Composition -->
                    <% composition = @celestial_body.atmospheric_composition %>
                    <% if composition.any? %>
                        <h4 class="subsection">Composition:</h4>
                        <% composition.each do |gas, percentage| %>
                            <div class="data-row">
                                <span class="data-label"><%= gas %>:</span>
                                <span class="data-value"><%= number_with_precision(percentage, precision: 2) %>%</span>
                            </div>
                        <% end %>
                    <% end %>
                <% else %>
                    <div class="data-row">
                        <span class="data-value warning">Not Present</span>
                    </div>
                <% end %>
            </div>
            
            <!-- Biosphere Section (only if present) -->
            <% if @celestial_body.biosphere %>
                <div class="data-section">
                    <h3>BIOSPHERE</h3>
                    <div class="data-row">
                        <span class="data-label">Biodiversity:</span>
                        <span class="data-value" id="bio-diversity">
                            <%= number_with_precision((@celestial_body.biosphere.biodiversity_index || 0) * 100, precision: 1) %>%
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="bio-diversity-bar" 
                             style="width: <%= (@celestial_body.biosphere.biodiversity_index || 0) * 100 %>%"></div>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Habitability:</span>
                        <span class="data-value" id="bio-habitability">
                            <%= number_with_precision((@celestial_body.biosphere.habitable_ratio || 0) * 100, precision: 1) %>%
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="bio-habitability-bar" 
                             style="width: <%= (@celestial_body.biosphere.habitable_ratio || 0) * 100 %>%"></div>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Life Forms:</span>
                        <span class="data-value" id="bio-lifeforms">
                            <%= @celestial_body.biosphere&.try(:dominant_life_forms) || 'None' %>
                        </span>
                    </div>
                </div>
            <% end %>
            

            <!-- Geosphere Section -->
            <% if @celestial_body.geosphere %>
                <div class="data-section">
                    <h3>GEOSPHERE</h3>
                    <div class="data-row">
                        <span class="data-label">Geological Activity:</span>
                        <span class="data-value" id="geo-activity">
                            <%= @celestial_body.geological_activity ? "#{number_with_precision(@celestial_body.geological_activity * 100, precision: 0)}%" : "Unknown" %>
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Tectonic Active:</span>
                        <span class="data-value" id="geo-tectonic">
                            <%= @celestial_body.geosphere.tectonic_activity ? 'Yes' : 'No' %>
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Core Mass:</span>
                        <span class="data-value" id="geo-core">
                            <%= number_to_human(@celestial_body.geosphere.total_core_mass || 0, precision: 2) %> kg
                        </span>
                    </div>
                </div>
            <% end %>

            <!-- Hydrosphere Section (only if present) -->
            <% if @celestial_body.hydrosphere %>
                <div class="data-section">
                    <h3>HYDROSPHERE</h3>
                    <div class="data-row">
                        <span class="data-label">Water Coverage:</span>
                        <span class="data-value">
                            <%= number_with_precision(@celestial_body.hydrosphere.water_coverage * 100, precision: 1) %>%
                        </span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Primary Liquid:</span>
                        <span class="data-value">
                            <%= @celestial_body.respond_to?(:primary_liquid) ? @celestial_body.primary_liquid : 'H2O' %>
                        </span>
                    </div>
                    <% if @celestial_body.hydrosphere.respond_to?(:total_water_mass) && @celestial_body.hydrosphere.total_water_mass %>
                    <div class="data-row">
                        <span class="data-label">Total Water Mass:</span>
                        <span class="data-value">
                            <%= number_to_human(@celestial_body.hydrosphere.total_water_mass, precision: 2) %> kg
                        </span>
                    </div>
                    <% end %>
                </div>
            <% end %>

            <!-- Active Missions (moved from sidebar) -->
            <% if @ai_missions.any? %>
                <div class="data-section">
                    <h3>üìã ACTIVE MISSIONS</h3>
                    <div class="mission-list">
                        <% @ai_missions.take(3).each do |mission| %>
                            <div class="mission-item <%= mission[:status] %>">
                                <div class="mission-header">
                                    <span class="mission-type"><%= mission[:type] %></span>
                                    <span class="mission-status"><%= mission[:status].upcase %></span>
                                </div>
                                <div class="mission-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: <%= mission[:progress] %>%"></div>
                                    </div>
                                    <span class="progress-text"><%= mission[:progress] %>%</span>
                                </div>
                            </div>
                        <% end %>
                    </div>
                </div>
            <% end %>
        </aside>
        <!-- Bottom Panel: Console -->
        <footer>
            <div class="console-line info">&gt; Admin monitoring system initialized for <%= @celestial_body.name %></div>
            <div class="console-line info">&gt; Sphere data loaded: <%= @sphere_summary.select { |k, v| v }.keys.join(', ') %></div>
            <div class="console-line info">&gt; Ready for AI Manager testing operations</div>
        </footer>
    </div>

    <%= javascript_include_tag 'admin/monitor' %>
</body>
</html>