module AIManager
  class DecisionTree
    # This class handles top-level decision making for the AI, prioritizing
    # survival (life support), then operational stability (resources), then expansion.
    
    def initialize(settlement, game_data_generator)
      @settlement = settlement
      @game_data_generator = game_data_generator # Needed for LLMPlannerService
      
      # Initialize operational AI components
      # NOTE: AIManager::Construction and AIManager::Builder are assumed to exist.
      @construction = AIManager::Construction.new(settlement, nil)
      @resource_planner = AIManager::ResourcePlanner.new(settlement)
      @builder = AIManager::Builder.new(settlement)
    end
    
    # Main decision method - decide what to do next
    def make_decisions
      # Get current state
      state = assess_settlement_state
      
      # Decide priority action based on state
      case
      when state[:life_support_at_risk]
        handle_life_support_emergency
      when state[:severe_resource_shortage]
        handle_resource_emergency
      when state[:needs_expansion]
        # Calls the LLM Planner for strategic growth
        handle_expansion_needs
      when state[:resource_shortage]
        handle_resource_needs
      when state[:can_upgrade]
        handle_upgrade_opportunity
      else
        handle_normal_operations
      end
    end
    
    private
    
    def assess_settlement_state
      # Check for various conditions and return a state hash
      {
        life_support_at_risk: life_support_at_risk?,
        severe_resource_shortage: severe_resource_shortage?,
        resource_shortage: resource_shortage?,
        needs_expansion: needs_expansion?,
        can_upgrade: can_upgrade?
      }
    end
    
    # Various state checking methods (simplified for brevity)
    
    def life_support_at_risk?
      @settlement.life_support_status == 'failing' ||
      @settlement.atmospheric_data&.o2_percentage.to_f < 18.0 ||
      @settlement.power_output_mw < @settlement.critical_power_needs_mw
    end
    
    def severe_resource_shortage?
      critical_resources = ['Oxygen', 'Water', 'Food']
      
      critical_resources.any? do |resource|
        current = @settlement.inventory.available(resource) rescue 0
        needed = calculate_critical_resource_needs(resource)
        
        current < (needed * 0.5) # Less than 50% of needed amount
      end
    end

    def resource_shortage?
      # Check for non-critical resources needed for current queue
      @resource_planner.identify_resource_shortfalls.any?
    end
    
    def needs_expansion?
      # Heuristic: Population is high and no current expansion is queued
      @settlement.current_population > @settlement.habitat_capacity * 0.9 &&
      !@settlement.construction_queue.expansion_plans_active?
    end

    def can_upgrade?
      # Heuristic: Sufficient capital and idle production capacity
      @settlement.can_afford?(1000000) && @settlement.production_lines.idle.any?
    end
    
    # --- HANDLER METHODS ---
    
    def handle_life_support_emergency
      Rails.logger.warn "[AI] Life support emergency detected in #{@settlement.name}! Triggering Survival Override."
      
      # 1. Cancel non-critical jobs
      # cancel_non_critical_jobs
      
      # 2. Trigger EMERGENCY resource procurement (may involve exceeding Earth Anchor Price limits)
      plan = @resource_planner.generate_procurement_plan
      @resource_planner.execute_procurement_plan(plan)
      
      # 3. Repair or replace failing systems
      # repair_failing_systems
    end
    
    def handle_resource_emergency
      Rails.logger.warn "[AI] Severe resource shortage in #{@settlement.name}! Generating emergency procurement plan."
      
      # Generate and execute the normal operational resource plan
      plan = @resource_planner.generate_procurement_plan
      @resource_planner.execute_procurement_plan(plan)
    end
    
    def handle_expansion_needs
      Rails.logger.info "[AI] Expansion needs detected. Calling LLM Planner for strategic growth."
      
      # The LLM Planner generates the high-level, multi-unit strategic plan (e.g., Phase 2)
      llm_planner = AIManager::LLMPlannerService.new(
        settlement_or_location_context: @settlement, 
        game_data_generator: @game_data_generator
      )
      
      # Call a generic expansion method
      plan = llm_planner.generate_expansion_plan
      
      if plan
        Rails.logger.info "[AI] LLM Planner successfully queued expansion plan: #{plan['plan_id']}"
      end
    end

    def handle_resource_needs
      Rails.logger.info "[AI] Resource shortage detected. Calling operational planner."
      plan = @resource_planner.generate_procurement_plan
      @resource_planner.execute_procurement_plan(plan)
    end
    
    def handle_upgrade_opportunity
      Rails.logger.info "[AI] Upgrade opportunity detected. Directing Builder to execute."
      # @builder.find_and_execute_upgrade_plan
    end
    
    def handle_normal_operations
      Rails.logger.debug "[AI] Normal operations. Idle or performing routine maintenance."
    end
    
    # Utility methods...
    
    def calculate_critical_resource_needs(resource)
      case resource
      when 'Oxygen'
        @settlement.current_population * 0.84 # kg per day per person
      when 'Water'
        @settlement.current_population * 2.5 # liters per day per person
      when 'Food'
        @settlement.current_population * 1.8 # kg per day per person
      else
        0
      end
    end
  end
e