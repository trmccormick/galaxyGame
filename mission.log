üîç DIAGNOSTIC TEST SUITE
========================

üìã Test 1: Verify PatternTargetMapper
--------------------------------------
2026-01-17T19:54:06.802Z pid=506 tid=1hm INFO: Sidekiq 7.3.8 connecting to Redis with options {size: 10, pool_name: "internal", url: "redis://redis:6379/1"}
1. Testing CelestialBody lookup:
   Mars found: NO - THIS IS THE PROBLEM!

2. Testing PatternTargetMapper:
   Target: NIL - MAPPER BROKEN!

üìã Test 2: Check if Debug Logging Was Added
--------------------------------------------
12:      Rails.logger.info "[MissionPlanner] Pattern: #{pattern_name}"
13:      Rails.logger.info "[MissionPlanner] Target location: #{@target_location&.name || 'NONE'}"
41:      Rails.logger.info "[MissionPlanner] MaterialLookupService initialized"
45:        Rails.logger.info "[MissionPlanner] PrecursorCapabilityService initialized for #{@target_location.name}"
46:        Rails.logger.info "[MissionPlanner] Local resources: #{service.local_resources.inspect}"

üìã Test 3: Run MissionPlanner and Check Logs
---------------------------------------------
2026-01-17T19:54:30.919Z pid=538 tid=ve INFO: Sidekiq 7.3.8 connecting to Redis with options {size: 10, pool_name: "internal", url: "redis://redis:6379/1"}

=== RESULTS SUMMARY ===
Target: Mars
Capability Service: PRESENT

Local Capabilities:
{available: true, location: "Mars", atmosphere: [], surface: [], subsurface: [], regolith: [], precursor_enables: {oxygen: false, water: false, fuel: false, metals: false, regolith_processing: nil}}

Sample Cost Data (first 3 resources):
  regolith:
    Chemical Formula: regolith_shielding_layer
    Source Type: import
    Source: Earth Import
    Transport Cost: 150.0 GCC/kg
    Unit Cost: 10.0 GCC/kg

  water_ice:
    Chemical Formula: water_ice
    Source Type: import
    Source: Earth Import
    Transport Cost: 150.0 GCC/kg
    Unit Cost: 50.0 GCC/kg

  structural_panels:
    Chemical Formula: structural_panels
    Source Type: import
    Source: Earth Import
    Transport Cost: 150.0 GCC/kg
    Unit Cost: 1000.0 GCC/kg


=== CHECKING LOGS FOR DEBUG OUTPUT ===
[MissionPlanner] Material data found: NO
[MissionPlanner] No material data for water_ice, using raw name
[MissionPlanner] Can produce locally: false
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:508:in 'AIManager::MissionPlannerService#find_best_regional_source'
[MissionPlanner] Using Earth import for water_ice
[MissionPlanner] Using estimated Earth price: 50 USD/kg
[MissionPlanner] Transport cost calculated: 150.0 GCC/kg
[MissionPlanner] EAP result: {material_cost: 50.0, transport_cost: 150.0, total: 200.0}
[MissionPlanner] EAP: material=50.0, transport=150.0, total=200.0
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:642:in 'AIManager::MissionPlannerService#find_alternative_sources'
[MissionPlanner] Calculating cost for structural_panels (8500 units)
[MissionPlanner] Material data found: NO
[MissionPlanner] No material data for structural_panels, using raw name
[MissionPlanner] Can produce locally: false
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:508:in 'AIManager::MissionPlannerService#find_best_regional_source'
[MissionPlanner] Using Earth import for structural_panels
[MissionPlanner] Using estimated Earth price: 1000 USD/kg
[MissionPlanner] Transport cost calculated: 150.0 GCC/kg
[MissionPlanner] EAP result: {material_cost: 1000.0, transport_cost: 150.0, total: 1150.0}
[MissionPlanner] EAP: material=1000.0, transport=150.0, total=1150.0
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:642:in 'AIManager::MissionPlannerService#find_alternative_sources'
[MissionPlanner] Calculating cost for power_modules (850 units)
[MissionPlanner] Material data found: NO
[MissionPlanner] No material data for power_modules, using raw name
[MissionPlanner] Can produce locally: false
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:508:in 'AIManager::MissionPlannerService#find_best_regional_source'
[MissionPlanner] Using Earth import for power_modules
[MissionPlanner] Using estimated Earth price: 5000 USD/kg
[MissionPlanner] Transport cost calculated: 150.0 GCC/kg
[MissionPlanner] EAP result: {material_cost: 5000.0, transport_cost: 150.0, total: 5150.0}
[MissionPlanner] EAP: material=5000.0, transport=150.0, total=5150.0
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:642:in 'AIManager::MissionPlannerService#find_alternative_sources'
[MissionPlanner] Calculating cost for regolith (170000 units)
[MissionPlanner] Material data found: YES
[MissionPlanner] Chemical formula: regolith_shielding_layer
[MissionPlanner] Can produce locally: false
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:508:in 'AIManager::MissionPlannerService#find_best_regional_source'
[MissionPlanner] Using Earth import for regolith
[MissionPlanner] Using estimated Earth price: 10 USD/kg
[MissionPlanner] Transport cost calculated: 150.0 GCC/kg
[MissionPlanner] EAP result: {material_cost: 10.0, transport_cost: 150.0, total: 160.0}
[MissionPlanner] EAP: material=10.0, transport=150.0, total=160.0
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:642:in 'AIManager::MissionPlannerService#find_alternative_sources'
[MissionPlanner] Calculating cost for water_ice (85000 units)
[MissionPlanner] Material data found: NO
[MissionPlanner] No material data for water_ice, using raw name
[MissionPlanner] Can produce locally: false
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:508:in 'AIManager::MissionPlannerService#find_best_regional_source'
[MissionPlanner] Using Earth import for water_ice
[MissionPlanner] Using estimated Earth price: 50 USD/kg
[MissionPlanner] Transport cost calculated: 150.0 GCC/kg
[MissionPlanner] EAP result: {material_cost: 50.0, transport_cost: 150.0, total: 200.0}
[MissionPlanner] EAP: material=50.0, transport=150.0, total=200.0
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:642:in 'AIManager::MissionPlannerService#find_alternative_sources'
[MissionPlanner] Calculating cost for structural_panels (8500 units)
[MissionPlanner] Material data found: NO
[MissionPlanner] No material data for structural_panels, using raw name
[MissionPlanner] Can produce locally: false
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:508:in 'AIManager::MissionPlannerService#find_best_regional_source'
[MissionPlanner] Using Earth import for structural_panels
[MissionPlanner] Using estimated Earth price: 1000 USD/kg
[MissionPlanner] Transport cost calculated: 150.0 GCC/kg
[MissionPlanner] EAP result: {material_cost: 1000.0, transport_cost: 150.0, total: 1150.0}
[MissionPlanner] EAP: material=1000.0, transport=150.0, total=1150.0
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:642:in 'AIManager::MissionPlannerService#find_alternative_sources'
[MissionPlanner] Calculating cost for power_modules (850 units)
[MissionPlanner] Material data found: NO
[MissionPlanner] No material data for power_modules, using raw name
[MissionPlanner] Can produce locally: false
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:508:in 'AIManager::MissionPlannerService#find_best_regional_source'
[MissionPlanner] Using Earth import for power_modules
[MissionPlanner] Using estimated Earth price: 5000 USD/kg
[MissionPlanner] Transport cost calculated: 150.0 GCC/kg
[MissionPlanner] EAP result: {material_cost: 5000.0, transport_cost: 150.0, total: 5150.0}
[MissionPlanner] EAP: material=5000.0, transport=150.0, total=5150.0
  ‚Ü≥ app/services/ai_manager/mission_planner_service.rb:642:in 'AIManager::MissionPlannerService#find_alternative_sources'
[MissionPlanner] Simulation complete
[MissionPlanner] Local capabilities present: true

üìã Test 4: Check calculate_costs Method
----------------------------------------
Looking for calculate_costs method implementation:
    def calculate_costs
      resources = @results[:resources] || calculate_resource_requirements
      
      total_cost = 0
      cost_breakdown = {}
      total_transport_cost = 0
      precursor_total_savings = 0
      
      resources[:total].each do |resource, quantity|
        # Use real market pricing with transport costs
        costing = calculate_total_delivered_cost(resource, quantity)
        
        cost_breakdown[resource] = {
          quantity: quantity,
          source: costing[:source],
          source_type: costing[:source_type],
          chemical_formula: costing[:chemical_formula],
          unit_cost: costing[:unit_cost],
          transport_cost_per_unit: costing[:transport_cost_per_unit],
          total_material_cost: costing[:total_material_cost],
          total_transport_cost: costing[:total_transport_cost],
          total: costing[:total],
          alternatives: costing[:alternatives]
        }
        
        total_cost += costing[:total]
        total_transport_cost += costing[:total_transport_cost]
        precursor_total_savings += costing[:precursor_savings] || 0
      end
      
      {

üìã Test 5: Verify summarize_local_capabilities Exists
------------------------------------------------------
‚úÖ summarize_local_capabilities method EXISTS
    def summarize_local_capabilities
      return { available: false } unless @capability_service
      
      capabilities = @capability_service.production_capabilities
      
      {
        available: true,
        location: @target_location.name,
        atmosphere: capabilities[:atmosphere],
        surface: capabilities[:surface],
        subsurface: capabilities[:subsurface],
        regolith: capabilities[:regolith],
        precursor_enables: {
          oxygen: @capability_service.precursor_enables?(:oxygen),
          water: @capability_service.precursor_enables?(:water),
          fuel: @capability_service.precursor_enables?(:fuel),
          metals: @capability_service.precursor_enables?(:metals),
          regolith_processing: @capability_service.precursor_enables?(:regolith_processing)
        }
      }
    end

üìã Test 6: Check TransportCostService
--------------------------------------
2026-01-17T19:54:53.294Z pid=570 tid=ui INFO: Sidekiq 7.3.8 connecting to Redis with options {size: 10, pool_name: "internal", url: "redis://redis:6379/1"}
Testing TransportCostService directly:
  Earth ‚Üí Mars transport: 150.0 GCC/kg
  ‚úÖ Working!

üìã Test 7: Check simulate Method
---------------------------------
Checking simulate method structure:
        timeline: calculate_timeline,
        resources: calculate_resource_requirements,
        costs: calculate_costs,
        local_capabilities: summarize_local_capabilities  # NEW
      Rails.logger.info "[MissionPlanner] Local capabilities present: #{@results[:local_capabilities].present?}"

üéØ SUMMARY: Check the output above for:
  1. Is Mars being found? (Test 1)
  2. Are debug logs present? (Test 2)
  3. What do the actual results show? (Test 3)
  4. Is calculate_costs calling calculate_total_delivered_cost? (Test 4)
  5. Does summarize_local_capabilities exist? (Test 5)
  6. Is TransportCostService working? (Test 6)
  7. Is simulate calling local_capabilities? (Test 7)

Run this and share the output - we'll identify the exact problem!
